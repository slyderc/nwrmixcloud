# Mixcloud Updater

Automatically updates Mixcloud show descriptions with formatted tracklists from CUE files generated by radio automation software like Myriad.

## Features

- **Unified Config-Driven Architecture**: Configure multiple shows with aliases, templates, and automation
- **Batch Processing**: Process all enabled shows automatically with priority ordering
- **Flexible Templating**: Go text/template-based formatting with custom functions
- **Auto-Discovery**: CUE file pattern matching and latest file selection
- **OAuth Integration**: Automatic Mixcloud authentication with token refresh
- **Production Ready**: Structured logging, retry logic, and comprehensive error handling

## Installation

### Download Releases

Download pre-built binaries from the [Releases](https://github.com/nowwaveradio/mixcloud-updater/releases) page.

### Build from Source

```bash
git clone https://github.com/nowwaveradio/mixcloud-updater.git
cd mixcloud-updater
go build ./cmd/mixcloud-updater
```

### Cross-Platform Builds

```bash
# Build for specific platforms
make build-windows    # Windows executable
make build-macos      # macOS executable
make build-all        # Both platforms
```

## Quick Start

1. **Initialize Configuration**:
   ```bash
   ./mixcloud-updater config.toml
   # Creates default config.toml with example settings
   ```

2. **Configure OAuth Credentials**:
   Edit `config.toml` and add your Mixcloud OAuth credentials:
   ```toml
   [oauth]
   client_id = "your-client-id"
   client_secret = "your-client-secret"
   ```

3. **Configure Shows**:
   ```toml
   [shows.my-show]
   cue_file_pattern = "*.cue"
   show_name_pattern = "My Weekly Show - {date}"
   aliases = ["weekly", "show"]
   enabled = true
   priority = 1
   ```

4. **Run**:
   ```bash
   ./mixcloud-updater config.toml  # Process all enabled shows
   ```

## Usage

### Basic Commands

```bash
# Process all enabled shows
./mixcloud-updater config.toml

# Process specific show by alias
./mixcloud-updater -show "weekly" config.toml

# Preview without updating Mixcloud
./mixcloud-updater -dry-run config.toml

# List available shows and aliases
./mixcloud-updater -list-shows config.toml

# List available templates
./mixcloud-updater -list-templates config.toml

# Use custom template
./mixcloud-updater -show "morning" -template "detailed" config.toml
```

### Command Line Options

- `-show string` - Process specific show by name/alias
- `-template string` - Template name to use for formatting
- `-dry-run` - Preview changes without updating Mixcloud
- `-list-shows` - List available shows and their aliases
- `-list-templates` - List available templates
- `-config string` - Config file path (default: config.toml)
- `-help` - Show help information
- `-version` - Show version information

## Configuration

### Complete config.toml Example

```toml
[station]
name = "My Radio Station"
mixcloud_username = "mystation"

[oauth]
client_id = "your-mixcloud-client-id"
client_secret = "your-mixcloud-client-secret"
access_token = ""  # Auto-populated during OAuth
refresh_token = "" # Auto-populated during OAuth

[filtering]
excluded_artists = ["Station ID", "Commercial", "Sweeper"]
excluded_titles = ["Station Identification", "Commercial Break"]
excluded_artist_patterns = ["(?i)promo", "(?i)station"]
excluded_title_patterns = ["(?i)advertisement", "(?i)jingle"]

[processing]
cue_file_directory = "/path/to/cue/files"
auto_process = true
batch_size = 5

# Show definitions
[shows.newer-new-wave]
cue_file_pattern = "MYR*.cue"
show_name_pattern = "The Newer New Wave Show - {date}"
aliases = ["nnw", "new-wave", "newer"]
template_name = "detailed"
date_extraction = "MYR(\\d{4})"
enabled = true
priority = 1

[shows.morning-show]
cue_file_mapping = "morning.cue"
show_name_pattern = "{station} Morning Show"
aliases = ["morning", "am"]
custom_template = \"\"\"
=== {{.ShowTitle}} ===
{{range .Tracks}}{{.StartTime}} - \"{{.Title}}\" by {{.Artist}}
{{end}}
Broadcast by {{.StationName}}
\"\"\"
enabled = true
priority = 2

[shows.sounds-like]
cue_file_pattern = "SL*.cue"
show_name_pattern = "Sounds Like - {date}"
aliases = ["sl", "sounds"]
template_name = "minimal"
enabled = false  # Disabled show
priority = 3

# Template definitions
[templates]
default = "detailed"

[templates.templates.minimal]
track = "{{.StartTime}} - {{.Title}} by {{.Artist}}"

[templates.templates.detailed]
header = "=== {{.ShowTitle}} ===\\nPlaylist:\\n"
track = "{{.Index}}. {{.StartTime}} - \\\"{{.Title}}\\\" by {{.Artist}}{{if .Genre}} ({{.Genre}}){{end}}"
footer = "\\nBroadcast by {{.StationName}} | Total: {{.TrackCount}} tracks"

[templates.templates.compact]
header = "Tracklist:\\n"
track = "{{.StartTime}} {{.Artist}} - {{.Title}}"
footer = "\\n({{.TrackCount}} tracks)"
```

### Configuration Sections

#### Station Settings
```toml
[station]
name = "Your Station Name"           # Used in templates as {{.StationName}}
mixcloud_username = "your-username"  # Your Mixcloud username
```

#### OAuth Configuration
```toml
[oauth]
client_id = "your-client-id"         # Mixcloud OAuth client ID
client_secret = "your-client-secret" # Mixcloud OAuth client secret
access_token = ""                    # Auto-populated
refresh_token = ""                   # Auto-populated
```

#### Content Filtering
```toml
[filtering]
excluded_artists = ["Station ID"]                    # Exact artist name matches
excluded_titles = ["Commercial"]                     # Exact title matches
excluded_artist_patterns = ["(?i)sweeper"]          # Regex patterns for artists
excluded_title_patterns = ["(?i)advertisement"]      # Regex patterns for titles
```

#### Processing Options
```toml
[processing]
cue_file_directory = "/path/to/cue/files"  # Base directory for CUE files
auto_process = true                         # Enable automatic processing
batch_size = 5                             # Number of shows to process concurrently
```

#### Show Definitions
```toml
[shows.show-key]
# CUE file source (choose one)
cue_file_mapping = "specific-file.cue"     # Direct file mapping
cue_file_pattern = "PATTERN*.cue"          # Glob pattern (finds latest)

# Show configuration
show_name_pattern = "Show Name - {date}"   # Show name with placeholders
aliases = ["alias1", "alias2"]             # Short names for CLI access
enabled = true                             # Enable/disable processing
priority = 1                              # Processing order (lower = first)

# Template selection (choose one)
template_name = "detailed"                 # Reference named template
custom_template = "{{.StartTime}} - {{.Title}}"  # Inline template

# Optional date extraction
date_extraction = "PATTERN(\\d{4})"       # Regex to extract date from filename
date_format = "01/02/2006"                # Go time format for date formatting
```

#### Template System
```toml
[templates]
default = "template-name"  # Default template for shows

[templates.templates.template-name]
header = "Header text with {{.ShowTitle}}"           # Optional header
track = "{{.StartTime}} - {{.Title}} by {{.Artist}}" # Required track format
footer = "Footer with {{.TrackCount}} tracks"        # Optional footer
```

### Template Variables

#### Track Variables
- `{{.Index}}` - Track number (1, 2, 3...)
- `{{.StartTime}}` - Start time (MM:SS)
- `{{.Title}}` - Song title
- `{{.Artist}}` - Artist name
- `{{.Genre}}` - Genre (if available)

#### Metadata Variables
- `{{.ShowTitle}}` - Generated show name
- `{{.ShowDate}}` - Show date
- `{{.StationName}}` - Station name from config
- `{{.TrackCount}}` - Total number of tracks

#### Custom Variables
Add custom variables in metadata:
```go
metadata := map[string]interface{}{
    "custom_var": "custom_value",
}
```
Access with `{{.Custom.custom_var}}`

#### Template Functions
- `{{upper .Artist}}` - Convert to uppercase
- `{{lower .Title}}` - Convert to lowercase  
- `{{truncate .Genre 10}}` - Truncate to 10 characters
- `{{repeat "X" 5}}` - Repeat string 5 times

## OAuth Setup

### Getting Mixcloud OAuth Credentials

1. Go to [Mixcloud Developers](https://www.mixcloud.com/developers/)
2. Create a new application
3. Note your Client ID and Client Secret
4. Add them to your `config.toml`

### First Run Authorization

On first run, the application will automatically open your browser for OAuth authorization:

```bash
./mixcloud-updater config.toml
# Browser opens automatically
# Follow OAuth flow on Mixcloud
# Tokens are saved automatically
```

### Subsequent Runs

Once authorized, the application runs unattended. Tokens are automatically refreshed as needed.

## CUE File Format

The application parses CUE files generated by radio automation software like Myriad:

```
PERFORMER "Show Host"
TITLE "Show Title"  
FILE "audio.wav" WAV
  TRACK 01 AUDIO
    TITLE "Song Title"
    PERFORMER "Artist Name"
    GENRE "Genre"
    INDEX 01 MM:SS:FF
  TRACK 02 AUDIO
    TITLE "Another Song"
    PERFORMER "Another Artist"
    INDEX 01 MM:SS:FF
```

### Supported Features
- UTF-8 BOM handling (Windows compatibility)
- Album-level and track-level metadata
- MM:SS:FF to MM:SS time conversion
- REM commands for extended metadata
- Genre-based filtering

## Production Automation

### Cron Job Setup

Process all enabled shows every 2 hours:
```bash
# Add to crontab with: crontab -e
0 */2 * * * /path/to/mixcloud-updater /path/to/config.toml
```

### Radio Software Integration

Add to your radio automation software's post-show hook:
```bash
# Option 1: Process all shows (recommended)
/path/to/mixcloud-updater /path/to/config.toml

# Option 2: Process specific show
/path/to/mixcloud-updater -show "$SHOW_ALIAS" /path/to/config.toml
```

### Advanced Automation Script

```bash
#!/bin/bash
# Production automation with logging
LOG_FILE="/var/log/mixcloud-updater.log"
CONFIG_FILE="/etc/mixcloud/config.toml"

echo "$(date): Starting Mixcloud update process" >> "$LOG_FILE"

if /path/to/mixcloud-updater "$CONFIG_FILE" >> "$LOG_FILE" 2>&1; then
    echo "$(date): Mixcloud update completed successfully" >> "$LOG_FILE"
else
    echo "$(date): Mixcloud update failed" >> "$LOG_FILE"
    # Send alert notification
    /usr/bin/mail -s "Mixcloud Update Failed" admin@station.com < "$LOG_FILE"
fi
```

## Troubleshooting

### Configuration Issues

**Show not found:**
```bash
# List available shows and aliases
./mixcloud-updater -list-shows config.toml
```

**Template issues:**
```bash
# List available templates
./mixcloud-updater -list-templates config.toml

# Test template with dry run
./mixcloud-updater -show "myshow" -template "mytemplate" -dry-run config.toml
```

**CUE file detection:**
- Verify `cue_file_directory` points to correct location
- Check `cue_file_pattern` matches your file naming
- Use absolute paths in `cue_file_mapping` when needed
- Ensure files have `.cue` extension

### OAuth Issues

**Re-authorization needed:**
```bash
# Delete tokens to force re-auth
sed -i '/access_token/d; /refresh_token/d' config.toml
./mixcloud-updater config.toml
```

**Browser doesn't open:**
- Check firewall settings
- Try running from terminal with GUI access
- Copy authorization URL manually if displayed

### Processing Issues

**No tracks after filtering:**
- Check `excluded_artists` and `excluded_titles` lists
- Review filtering patterns for overly broad exclusions
- Use `-dry-run` to see filtering results

**Formatting issues:**
- Verify template syntax with Go text/template documentation
- Check character limit (1000 chars for Mixcloud)
- Test custom templates with simple shows first

**API errors:**
- Verify show exists on Mixcloud
- Check internet connection
- Review Mixcloud API status
- Try with `-dry-run` first

### Common Solutions

1. **Use dry-run mode** for testing: `-dry-run`
2. **Check logs** for detailed error information
3. **Verify show URLs** exist on Mixcloud
4. **Test incrementally** - start with one simple show
5. **Check file permissions** for CUE file directory

## Dependencies

- Go 1.19 or later
- [BurntSushi/toml](https://github.com/BurntSushi/toml) - TOML parsing
- [golang.org/x/oauth2](https://golang.org/x/oauth2) - OAuth 2.0
- [golang.org/x/text](https://golang.org/x/text) - Unicode support

## License

MIT License - see LICENSE file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

## Support

- [Issues](https://github.com/nowwaveradio/mixcloud-updater/issues) - Bug reports and feature requests
- [Discussions](https://github.com/nowwaveradio/mixcloud-updater/discussions) - Questions and community support